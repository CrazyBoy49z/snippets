# ANMERKUNG: ## Zeilen mit zwei Rauten sind Kommentare, solche mit einer # abgeschaltete Anweisungen. ### Drei Rauten markieren den Beginn thematischer Abschnitte

### Sicherheitseinstellungen

<IfModule mod_headers.c>
    ## verhindert das Untermogeln faslcher MIME-Typen, etwa das Tarnen von JavaScipt als Bilddateien: http://www.golem.de/news/cross-site-scripting-javascript-code-in-bilder-einbetten-1411-110264-2.html
    Header set X-Content-Type-Options nosniff
    ## Entfernt den Header, aud dem sich die verwendete PHP Version auslesen lässt
    Header unset X-Powered-By
    ## Unterdrückt die Übertragung von Details über den Server
    Header unset SERVER
     ## Verhindert einige Cross-Site-Scripting-Attacken: https://de.wikipedia.org/wiki/Cross-Site-Scripting
     Header set X-XSS-Protection "1; mode=block"
     ## verhindert die Übernahme von Inhalten in Frames auf anderen Seiten
    Header set X-Frame-Options "SAMEORIGIN"
    ## mit Content-Securtiy-Policy kann definiert werden, aus welchen Quellen der zum Browser übertragen Code stammen darf. Die Sache ist gut, aber nicht ganz trivial, Erläuterungen siehe https://www.html5rocks.com/en/tutorials/security/content-security-policy/ und https://developer.mozilla.org/en-US/docs/Web/Security/CSP
    #Header set Content-Security-Policy: "base-uri https://junkers-paddelgemeinschaft.de; default-src https:; script-src https: 'unsafe-inline' 'unsafe-eval'; style-src https: 'unsafe-inline'; child-src https://junkers-paddelgemeinschaft.de https://www.youtube-nocookie.com/" 
     ## nur für HTML, nicht für…
     <FilesMatch "\.(appcache|atom|bbaw|bmp|crx|css|cur|eot|f4[abpv]|flv|geojson|gif|htc|ico|jpe?g|js|json(ld)?|m4[av]|manifest|map|mp4|oex|og[agv]|opus|otf|pdf|png|rdf|rss|safariextz|svgz?|swf|topojson|tt[cf]|txt|vcard|vcf|vtt|webapp|web[mp]|webmanifest|woff2?|xloc|xml|xpi)$">
        Header unset X-XSS-Protection
        Header unset X-Frame-Options
        Header unset Content-Security-Policy
    </FilesMatch>
</IfModule>




## Unterdrückt Informationen über den Server: https://httpd.apache.org/docs/2.2/de/mod/core.html#serversignature
ServerSignature Off

## Schützt die .htaccess vor Zugriff
<Files ~ "^.*\.([Hh][Tt][Aa])">
    order allow,deny
    deny from all
    satisfy all
</Files>


## Für MODx: blockiert direkte Aufrufe der config.inc.php 
<Files "config.inc.php">
    order allow,deny
    deny from all
    satisfy all
</Files>


## Beispiel: Zugriff auf sicherheitsrelevante Dateien unterbinden wie meine-datei.bak oder meine-datei.config
#<FilesMatch "(\.(bak|config|sql|fla|ini|log|sh|inc|swp|dist)|~)$">
#    Order allow,deny
#    Deny from all
#    Satisfy All
#</FilesMatch>

## Unterbindet das Auflisten der Serverdateien im Browser
Options -Indexes
IndexIgnore *


## Gefährliche Anfragen unterbinden
<IfModule mod_rewrite.c>
	RewriteEngine On
	RewriteCond %{QUERY_STRING} (eval\() [NC,OR]
    RewriteCond %{QUERY_STRING} revslider [NC,OR]
	RewriteCond %{QUERY_STRING} (127\.0\.0\.1) [NC,OR]
	RewriteCond %{QUERY_STRING} ([a-z0-9]{2000}) [NC,OR]
	RewriteCond %{QUERY_STRING} (javascript:)(.*)(;) [NC,OR]
	RewriteCond %{QUERY_STRING} (base64_encode)(.*)(\() [NC,OR]
	RewriteCond %{QUERY_STRING} (GLOBALS|REQUEST)(=|\[|%) [NC,OR]
	RewriteCond %{QUERY_STRING} (<|%3C)(.*)script(.*)(>|%3) [NC,OR]
    ## Folgende Regel für MODx Evo auskommentieren, verhindert Öffnen des Verzeichnisbaums
	#RewriteCond %{QUERY_STRING} (\\|\.\.\.|\.\./|~|`|<|>|\|) [NC,OR]
	RewriteCond %{QUERY_STRING} (boot\.ini|etc/passwd|self/environ) [NC,OR]
	RewriteCond %{QUERY_STRING} (thumbs?(_editor|open)?|tim(thumb)?)\.php [NC,OR]
	RewriteCond %{QUERY_STRING} (\'|\")(.*)(drop|insert|md5|select|union) [NC]
	RewriteRule .* - [F]
</IfModule>


<IfModule mod_rewrite.c>
	RewriteCond %{REQUEST_METHOD} ^(connect|debug|delete|move|put|trace|track) [NC]
	RewriteRule .* - [F]
</IfModule>

<IfModule mod_rewrite.c>
	RewriteCond %{REQUEST_URI}  (mssqlil|register|manager).php [NC,OR]
	RewriteCond %{REQUEST_URI}  (img|thumb|thumb_editor|thumbopen).php [NC,OR]
	RewriteCond %{QUERY_STRING} (img|thumb|thumb_editor|thumbopen).php [NC,OR]
	RewriteCond %{REQUEST_URI}  revslider [NC,OR]
	RewriteCond %{QUERY_STRING} revslider [NC]
	RewriteRule .* - [F,L]
</IfModule>

<IfModule mod_rewrite.c>
	RewriteCond %{HTTP_REFERER} ([a-z0-9]{2000}) [NC,OR]
	RewriteCond %{HTTP_REFERER} (semalt.com|todaperfeita) [NC]
	RewriteRule .* - [F]
</IfModule>


<IfModule mod_alias.c>
	RedirectMatch 403 (?i)([a-z0-9]{2000})
	RedirectMatch 403 (?i)(https?|ftp|php):/
	RedirectMatch 403 (?i)(base64_encode)(.*)(\()
	RedirectMatch 403 (?i)(=\\\'|=\\%27|/\\\'/?)\.
	RedirectMatch 403 (?i)/(\$(\&)?|\*|\"|\.|,|&|&amp;?)/?$
	RedirectMatch 403 (?i)(\{0\}|\(/\(|\.\.\.|\+\+\+|\\\"\\\")
	RedirectMatch 403 (?i)(~|`|<|>|:|;|,|%|\\|\s|\{|\}|\[|\]|\|)
	RedirectMatch 403 (?i)/(=|\$&|_mm|cgi-|etc/passwd|muieblack)
	RedirectMatch 403 (?i)(&pws=0|_vti_|\(null\)|\{\$itemURL\}|echo(.*)kae|etc/passwd|eval\(|self/environ)
	RedirectMatch 403 (?i)\.(aspx?|bash|bak?|cfg|cgi|dll|exe|git|hg|ini|jsp|log|mdb|out|sql|svn|swp|tar|rar|rdf)$
	RedirectMatch 403 (?i)/(^$|(wp-)?config|mobiquo|phpinfo|shell|sqlpatch|thumb_editor|thumbopen|timthumb|webshell)\.php
    RedirectMatch 410 (NULL(.*)NULL(.*)NULL|INFORMATION_SCHEMA\.CHARACTER_SETS|SELECT(.*)CASE(.*)WHEN|AND(.*)AND(.*)oNnL|CONVERT(.*)INT(.*)SELECT|SELECT(.*)SLEEP|WAITFOR(.*)DELAY|DBMS_PIPE\.RECEIVE_MESSAGE)
</IfModule>


<IfModule mod_setenvif.c>
	SetEnvIfNoCase User-Agent ([a-z0-9]{2000}) bad_bot
	SetEnvIfNoCase User-Agent (archive.org|binlar|casper|checkpriv|choppy|clshttp|cmsworld|diavol|dotbot|extract|feedfinder|flicky|g00g1e|harvest|heritrix|httrack|kmccrew|loader|miner|nikto|nutch|planetwork|postrank|purebot|pycurl|python|seekerspider|siclab|skygrid|sqlmap|sucker|turnit|vikspider|winhttp|xxxyy|youda|zmeu|zune) bad_bot
</IfModule>	
    
    ## Apache < 2.3
	<IfModule !mod_authz_core.c>
		Order Allow,Deny
		Allow from all
		Deny from env=bad_bot
	</IfModule>

	## Apache >= 2.3
	<IfModule mod_authz_core.c>
		<RequireAll>
			Require all Granted
			Require not env bad_bot
		</RequireAll>
	</IfModule>

## Session-Cookie gegen Manipulation absichern http://stackoverflow.com/questions/23529234/use-strict-mode-in-php-sessions
php_value session.use_strict_mode 1
## Kein Zugriff auf Seesion-ID mit JS
php_value session.cookie_httponly 1
## Session-ID wird nur in Cookies übertragen, nicht als URL-Parameter
php_value session.use_cookies 1
php_value session.use_only_cookies 1
php_value session.use_trans_sid 0
## Nur bei https verwenden
#php_value session.cookie_secure 1

## Ab PHP 5.4: sicherer hash des Session-Cookies
#php_value session.hash_function sha512

## Laden von remote-Code unterbinden
php_value allow_url_fopen Off
php_value allow_url_include Off

### Server-Einstellungen

## Erst für die produktive Site freigeben. Pfad ermitteln mit PHP-Datei im root der Site mit folgendem Inhalt: <?php echo $_SERVER["DOCUMENT_ROOT"] ?> Datei anschließend löschen!
#php_value open_basedir /www/htdocs/w00f2f21/web/modx11/

## Nur frreischalten, wenn keine weiteren .htaccess-Dateien in Unterverzeichnissen stecken
#AllowOverride None

### Server-Einstellungen

## Veraltet! Ab PHP 5.4 überflüssig. Aber wer fährt schon auf älteren Systemen?
# php_flag magic_quotes_gpc off
## Veraltet
# php_value date.timezone Europe/Berlin

## Hauptsprache festlegen
DefaultLanguage de-DE
## Zeichensatz definieren
AddDefaultCharset UTF-8
## Zeitzone bestimmen
SetEnv TZ Europe/Berlin

## Zwingt IE8 bis 10 in den höchst verfügbaren Rendering-Modus 
<IfModule mod_headers.c>
    Header set X-UA-Compatible "IE=edge"
    <FilesMatch "\.(appcache|atom|bbaw|bmp|crx|css|cur|eot|f4[abpv]|flv|geojson|gif|htc|ico|jpe?g|js|json(ld)?|m4[av]|manifest|map|mp4|oex|og[agv]|opus|otf|pdf|png|rdf|rss|safariextz|svgz?|swf|topojson|tt[cf]|txt|vcard|vcf|vtt|webapp|web[mp]|webmanifest|woff2?|xloc|xml|xpi)$">
        Header unset X-UA-Compatible
    </FilesMatch>
</IfModule>



### Umleitungen

RewriteEngine On
## Die nächsten beiden Optionen abschalten, wenn der Hoster sie nicht erlaubt
Options +FollowSymlinks
Options +SymLinksIfOwnerMatch
RewriteBase /


## Lästige Spider sperren
RewriteCond %{HTTP_REFERER} ^http://.*trainersuchmaschine\.de [NC,OR]
RewriteCond %{HTTP_REFERER} ^http://.*vebidoo\.de [NC]
RewriteRule .* - [F,L] 

## Kritische Anfragen sperren
RedirectMatch 410 (NULL(.*)NULL(.*)NULL|INFORMATION_SCHEMA\.CHARACTER_SETS|SELECT(.*)CASE(.*)WHEN|AND(.*)AND(.*)oNnL|CONVERT(.*)INT(.*)SELECT|SELECT(.*)SLEEP|WAITFOR(.*)DELAY|DBMS_PIPE\.RECEIVE_MESSAGE)


## unsinige Google-Anfrage abblocken
RedirectMatch 403 (?i)\.well-known
RedirectMatch 403 (?i)apple-app-site-association

### ACHTUNG! Die nächsten drei Blöcke schleißen sich gegenseitig aus

## Rewrite deine-site.de -> www.deine-site.de
#RewriteCond %{HTTP_HOST} .
#ewriteCond %{HTTP_HOST} !^www\.example\.de [NC]
#RewriteRule (.*) http://www.deine-site.de/$1 [R=301,L]

## Rewrite www.deine-site.de -> deine-site.de
#RewriteCond %{HTTP_HOST} .
#RewriteCond %{HTTP_HOST} !^deine-site\.de [NC]
#RewriteRule (.*) http://deine-site.de/$1 [R=301,L]


## Rewrite deine-site.de oder www.deine-site.de auf https://deine-site.de
#RewriteCond %{REQUEST_SCHEME} http [OR]
#RewriteCond %{HTTP_HOST} ^www\.
#RewriteRule ^ https://deine-site.de%{REQUEST_URI} [NE,L,R]


## Zeitstempel einfügen in Dateien nach dem Schema mein-script.min.js. Muss mit PHP aufgelöst werden, verhindert den Rückgriff auf im Browser gecachte Version, wenn CSS- oder JS-Dateien aktualisiert werden
RewriteRule (.+)\.(min|dev)\.(\d+)\.(js|css)$ $1.$2.$4 [L]

## für MODx Evo: Exclude /assets and /manager directories and images from rewrite rules
#RewriteRule ^(manager|assets|js|css|images|img)/.*$ - [L]
#RewriteRule \.(jpg|jpeg|png|gif|ico)$ - [L]

## für MODx Evo: Fix Apache internal dummy connections from breaking [(site_url)] cache
#RewriteCond %{HTTP_USER_AGENT} ^.*internal\ dummy\ connection.*$ [NC]
#RewriteRule .* - [F,L]

## für MODx Evo: For Friendly URLs
#RewriteCond %{REQUEST_FILENAME} !-f
#RewriteCond %{REQUEST_FILENAME} !-d
#RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]

## Beispiel für interne Umleitung einer alten auf eine neue Seite
#Redirect 301 /neu http://domain.tld/alt

## Dateitypen festlegen
<IfModule mod_mime.c>
	DefaultType text/html
	
	AddType application/pdf 					pdf
	AddType text/css 							css
	AddType text/javascript 					js
	AddType application/javascript          	js
	AddType application/json                	json
	
	AddType image/jpeg 							jpg
	AddType image/png 							png
	AddType image/gif 							gif
	AddType image/x-icon 						ico
	
	AddType image/svg+xml  						svg svgz 
	AddEncoding gzip  							svgz
	
	AddType font/truetype                  		ttf
	AddType application/x-font-woff        		woff
	AddType application/font-woff2  			woff2
	
	AddType audio/mpeg 							mp3
	AddType audio/mp4 							m4a mp4 mpa                                                           
	AddType audio/ogg 							ogg
	AddType audio/ogg 							oga
	AddType audio/webm 							webma
	AddType audio/wav 							wav
	
	AddType video/ogg 							ogv
	AddType video/ogg 							ogg
	AddType video/mp4 							mp4
	AddType video/webm 							webm
	AddType application/x-shockwave-flash   	swf
	
	AddType text/calendar                       ics  
	
	AddType application/xml                     rss atom xml rdf
	AddType application/x-chrome-extension      crx
	AddType application/x-opera-extension       oex
	AddType application/x-xpinstall             xpi
	AddType application/octet-stream            gpx
	AddType application/octet-stream            kml
	AddType application/octet-stream            kmz 
	AddType text/x-vcard                        vcf
	AddType text/vtt                            vtt
</IfModule>

### Komprimierung einschalten
<IfModule mod_deflate.c>
 AddOutputFilterByType DEFLATE "application/atom+xml" \
                               "application/javascript" \
                               "application/json" \
                               "application/ld+json" \
                               "application/manifest+json" \
                               "application/rdf+xml" \
                               "application/rss+xml" \
                               "application/schema+json" \
                               "application/vnd.geo+json" \
                               "application/vnd.google-earth.kml+xml" \
                               "application/vnd.ms-fontobject" \
                               "application/x-font-ttf" \
                               "application/x-javascript" \
                               "application/x-web-app-manifest+json" \
                               "application/xhtml+xml" \
                               "application/xml" \
                               "font/eot" \
                               "font/opentype" \
                               "image/bmp" \
                               "image/svg+xml" \
                               "image/vnd.microsoft.icon" \
                               "image/x-icon" \
                               "text/cache-manifest" \
                               "text/calendar" \
                               "text/css" \
                               "text/html" \
                               "text/javascript" \
                               "text/plain" \
                               "text/vcard" \
                               "text/vnd.rim.location.xloc" \
                               "text/vtt" \
                               "text/x-component" \
                               "text/x-cross-domain-policy" \
                               "text/xml"
</IfModule>


### Cache-Zeiten festlegen. 
<IfModule mod_expires.c>
    ## Die folgende Zeile während der Entwicklung auskommentieren
	ExpiresActive on
	ExpiresDefault "access plus 1 month"
	 
	# CSS
	ExpiresByType text/css "access plus 1 year"
	
	# Data interchange
	ExpiresByType application/atom+xml "access plus 1 hour"
	ExpiresByType application/rdf+xml "access plus 1 hour"
	ExpiresByType application/rss+xml "access plus 1 hour"
	ExpiresByType application/json "access plus 0 seconds"
	ExpiresByType application/vnd.geo+json "access plus 0 seconds"
	ExpiresByType application/xml "access plus 0 seconds"
	ExpiresByType text/xml "access plus 0 seconds"
	ExpiresByType text/calendar "access plus 6 hours"
	
	# Favicon (cannot be renamed!) and cursor images
	ExpiresByType image/vnd.microsoft.icon "access plus 1 week"
	ExpiresByType image/x-icon "access plus 1 week"
	
	# HTML
	ExpiresByType text/html "access plus 5 minutes"
	
	# JavaScript
	ExpiresByType application/javascript "access plus 1 year"
	ExpiresByType application/x-javascript "access plus 1 year"
	ExpiresByType text/javascript "access plus 1 year"
	
	# Manifest files
	ExpiresByType application/manifest+json "access plus 1 year"
	ExpiresByType application/x-web-app-manifest+json "access plus 0 seconds"
	ExpiresByType text/cache-manifest "access plus 0 seconds"
	
	# Media files
	ExpiresByType audio/ogg "access plus 1 year"
	ExpiresByType image/bmp "access plus 1 year"
	ExpiresByType image/gif "access plus 1 year"
	ExpiresByType image/jpeg "access plus 1 year"
	ExpiresByType image/png "access plus 1 year"
	ExpiresByType image/svg+xml "access plus 1 year"
	ExpiresByType video/mp4 "access plus 1 year"
	ExpiresByType video/ogg "access plus 1 year"
	ExpiresByType video/webm "access plus 1 year"
	
	# Web fonts
	ExpiresByType application/x-font-ttf "access plus 1 year"
	ExpiresByType application/font-woff "access plus 1 year"
	ExpiresByType application/x-font-woff "access plus 1 year"
	ExpiresByType font/woff "access plus 1 year"
	ExpiresByType font/font-woff2 "access plus 1 year"
	
	# Other
	ExpiresByType text/x-cross-domain-policy "access plus 1 week" 
  
  	# alte Browser
  	BrowserMatch "MSIE" brokenvary=1
	BrowserMatch "Mozilla/4.[0-9]{2}" brokenvary=1
	BrowserMatch "Opera" !brokenvary
	SetEnvIf brokenvary 1 force-no-vary
</IfModule>


Header set Connection keep-alive
<IfModule mod_headers.c>
Header unset ETag
Header set Cache-Control "private, no-transform"
    <FilesMatch "\.(css|gif|jpe?g|pdf|png|svg|ttf|woff|woff2)$">
        Header set Cache-Control "public, private"
    </FilesMatch>
</IfModule>
    
FileETag None

#php_flag log_errors on
#php_value error_log "/www/htdocs/w00f2f21/errlog/errlog.txt"