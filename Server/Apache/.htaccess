###### Version 2.0 beta12
##### GLOBAL ===========

#### NIE LÖSCHEN
    RewriteEngine On

#### BESUCHER SPERREN
## SET! nach TLD 
    RewriteCond %{HTTP_REFERER} ^https?://[^/]+\.(br|by|in|kz|no|ru|pk|ro|tr|ua)/? [NC]
    RewriteRule .* - [F,L]
## nach Referer
    RewriteCond %{HTTP_REFERER} (1-free-share-buttons|aviav|electricwheelchairsarea.com|offbyone|semalt|todaperfeita|trainersuchmaschine|vebidoo|wp-login.php) [NC,OR]
    RewriteCond %{HTTP_REFERER} ([a-z0-9]{2000,}) [NC]
    RewriteRule .* - [F,L]
## nach Request-Methoden
    RewriteCond %{REQUEST_METHOD} ^(connect|debug|move|put|trace|track) [NC]
    RewriteRule .* - [F,L]
## nach User-Agent
    SetEnvIfNoCase User-Agent ([a-z0-9]{2000,}) bad_bot
	SetEnvIfNoCase User-Agent (AhrefsBot|BLEXBot|boogle|dataprovider|flamingosearch|HaosouSpider|megaindex|MetaJobBot|MJ12bot|netcraft|offbyone|OpenLinkProfiler|SEOkicks|seoscanners|ubermetrics|WBSearchBot|wotbox|XoviBot) bad_bot
    SetEnvIfNoCase User-Agent (archive.org|binlar|casper|checkpriv|choppy|clshttp|cmsworld|diavol|dotbot|extract|feedfinder|flicky|g00g1e|harvest|heritrix|httrack|kmccrew|loader|miner|nikto|nutch|planetwork|postrank|purebot|pycurl|python|seekerspider|siclab|skygrid|sqlmap|sucker|turnit|vikspider|winhttp|xxxyy|youda|zmeu|zune) bad_bot
## nach IP-Adressen SET!
    <Limit GET HEAD OPTIONS POST PUT>
        order deny,allow
        allow from all
        # Indien
        deny from 139.59.0.0/24
        # Russland
        deny from  89.204.0.0/24
    </Limit>

#### KRITISCHE DATEIEN BLOCKIEREN 
## (.htaccess, *.inc.php, Google-Bestätigung)
    <FilesMatch "(^.*\.(htaccess)|(\.(?:inc.php)$)|(^google[0-9a-zA-Z]+.html$))">
        order allow,deny
        deny from all
    </FilesMatch>
## weitere Dateiendungen
    RewriteCond %{REQUEST_URI} \.(7z|aspx?|bash|bak?|bz2|cfg|cgi|dist|dll|exe|fla|git|hg|ini|jsp|log|mdb|old|out|rar|rdf|sql|sik|sh|svn|swp|tar|tlp)$ [NC]
	RewriteRule .* - [F,L]    


#### ANFRAGEN BLOCKIEREN

## TODO! Nicht unbedingt erforderliche MODx-Verzeichnisse komplett blockieren  
    #RewriteCond %{REQUEST_URI} ([assets\/](backup|export|flash|import)) [NC]
    #RewriteRule .* - [F,L]
## TODO! PHP in typischen MODx-Verzeichnissen blockieren, wo dies nicht erforderlich ist      
    #RewriteCond %{REQUEST_URI} ([assets\/](\.thumbs|drgalleries|images|galleries|js))*\.php [NC]
    #RewriteRule .* - [F,L]
## TODO! Blockade von PHP in zusätzlich eingerichteten Verzeichnissen
    #RewriteCond %{REQUEST_URI} ([client\/](css|scripts|grafik|fonts))*\.php [NC]
    #RewriteRule .* - [F,L]    
    RewriteCond %{REQUEST_URI}  (oaklayer|phpmyadmin|raybaner|revslider|test-for-404-page|tel:+) [NC,OR]
    RewriteCond %{REQUEST_URI}  (wordpress|([wp-](admin|config|content|includes|login))|wpcontent) [NC,OR]
    RewriteCond %{QUERY_STRING} (eval\() [NC,OR]
	RewriteCond %{QUERY_STRING} (127\.0\.0\.1) [NC,OR]
	RewriteCond %{QUERY_STRING} ([a-z0-9]{2000,}) [NC,OR]
    RewriteCond %{QUERY_STRING} (https?|ftp|php):/ [NC,OR]
	RewriteCond %{QUERY_STRING} (javascript:)(.*)(;) [NC,OR]
	RewriteCond %{QUERY_STRING} (base64_encode)(.*)(\() [NC,OR]
	RewriteCond %{QUERY_STRING} (GLOBALS|REQUEST)(=|\[|%) [NC,OR]
	RewriteCond %{QUERY_STRING} (<|%3C)(.*)script(.*)(>|%3) [NC,OR]
## SET! Folgende Regel für MODx Evo eventuell auskommentieren, verhindert Öffnen des Verzeichnisbaums
	#RewriteCond %{QUERY_STRING} (\\|\.\.\.|\.\./|~|`|<|>|\|) [NC,OR]
	RewriteCond %{QUERY_STRING} (boot\.ini|etc/passwd|self/environ) [NC,OR]
	RewriteCond %{QUERY_STRING} (thumbs?(_editor|open)?|tim(thumb)?)\.php [NC,OR]
	RewriteCond %{QUERY_STRING} (\'|\")(.*)(drop|insert|md5|select|union) [NC,OR]
    RewriteCond %{QUERY_STRING} (=\\\'|=\\%27|/\\\'/?)\. [NC,OR]
    RewriteCond %{QUERY_STRING} (?i)/(\$(\&)?|\*|\"|\.|,|&|&amp;?)/?$ [NC,OR]
	RewriteCond %{QUERY_STRING} (?i)(\{0\}|\(/\(|\.\.\.|\+\+\+|\\\"\\\") [NC,OR]
	RewriteCond %{QUERY_STRING} (?i)(~|`|<|>|:|,|\\|\s|\{|\}|\[|\]) [NC,OR]
## SET! Kann eventuell den Datei-Manager blockieren
    #RewriteCond %{QUERY_STRING} (?i)(%) [NC,OR]
## SET! Kann eventuell den Anforderung eines neuen PW im webloginpe blockieren
    #RewriteCond %{QUERY_STRING} (?i)(;) [NC,OR]   
	RewriteCond %{QUERY_STRING} (?i)/(=|\$&|_mm|cgi-|etc/passwd|muieblack) [NC,OR]
	RewriteCond %{QUERY_STRING} (?i)(&pws=0|_vti_|\(null\)|\{\$itemURL\}|echo(.*)kae|etc/passwd|eval\(|self/environ) [NC]
    RewriteRule .* - [F,L]
## PHP-DATEIEN gezielt blockieren
    RewriteCond %{REQUEST_URI} (admin-post|css-min|etchk|etpost|etreply|glnoa|green)\.php [NC,OR]
    RewriteCond %{REQUEST_URI} (img|map|master|mobiquo|minify|phpinfo|red|register|shell|sqlpatch|thumb|thumb_editor|thumbopen|timthumb|ui-elements|up|webshell|xml81|xmlrpc)\.php [NC,OR]
## Phantasie-Endung blockieren  
    RewriteCond %{REQUEST_URI} \.(nhtm|phpx) [NC]
    RewriteRule .* - [F,L]
## Datenbankabfragen
    RewriteCond %{QUERY_STRING} (NULL(.*)NULL(.*)NULL|INFORMATION_SCHEMA\.CHARACTER_SETS|SELECT(.*)CASE(.*)WHEN|AND(.*)AND(.*)oNnL|CONVERT(.*)INT(.*)SELECT|SELECT(.*)SLEEP|WAITFOR(.*)DELAY|DBMS_PIPE\.RECEIVE_MESSAGE) [NC]
    RewriteRule .* - [F,L]


#### BAD BOTS STOPPEN
## Apache < 2.3
    <IfModule !mod_authz_core.c>
        Order Allow,Deny
        Allow from all
        Deny from env=bad_bot
    </IfModule>
 ## Apache >= 2.3
    <IfModule mod_authz_core.c>
        <RequireAll>
            Require all Granted
            Require not env bad_bot
        </RequireAll>
    </IfModule>


#### CACHE

    <IfModule mod_expires.c>
## SET! Die folgende Zeile während der Entwicklung eventuell auskommentieren
        ExpiresActive on
        ExpiresDefault "access plus 1 month"

        ExpiresByType text/css "access plus 1 year"

        ExpiresByType application/atom+xml "access plus 1 hour"
        ExpiresByType application/rdf+xml "access plus 1 hour"
        ExpiresByType application/rss+xml "access plus 1 hour"
        ExpiresByType application/json "access plus 0 seconds"
        ExpiresByType application/vnd.geo+json "access plus 0 seconds"
        ExpiresByType application/xml "access plus 0 seconds"
        ExpiresByType text/xml "access plus 0 seconds"
        ExpiresByType text/calendar "access plus 6 hours"

        ExpiresByType image/vnd.microsoft.icon "access plus 1 week"
        ExpiresByType image/x-icon "access plus 1 week"

        ExpiresByType text/html "access plus 5 minutes"

        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType application/x-javascript "access plus 1 year"
        ExpiresByType text/javascript "access plus 1 year"

        ExpiresByType application/manifest+json "access plus 1 year"
        ExpiresByType application/x-web-app-manifest+json "access plus 0 seconds"
        ExpiresByType text/cache-manifest "access plus 0 seconds"

        ExpiresByType audio/ogg "access plus 1 year"
        ExpiresByType image/bmp "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType video/mp4 "access plus 1 year"
        ExpiresByType video/ogg "access plus 1 year"
        ExpiresByType video/webm "access plus 1 year"

        ExpiresByType application/x-font-ttf "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType font/woff2    "access plus 1 year"
        
        ExpiresByType text/x-cross-domain-policy "access plus 1 week" 

## alte Browser
        BrowserMatch "MSIE" brokenvary=1
        BrowserMatch "Mozilla/4.[0-9]{2}" brokenvary=1
        BrowserMatch "Opera" !brokenvary
        SetEnvIf brokenvary 1 force-no-vary
    </IfModule>


#### MIME-Tpyen

    <IfModule mod_mime.c>
        DefaultType text/html

        AddType application/pdf 					pdf
        AddType text/css 							css
        AddType text/javascript 					js
        AddType application/javascript          	js
        AddType application/json                	json

        AddType image/jpeg 							jpg
        AddType image/png 							png
        AddType image/gif 							gif
        AddType image/x-icon 						ico

        AddType image/svg+xml  						svg svgz 
        AddEncoding gzip  							svgz

        AddType font/truetype                  		ttf
        AddType application/font-woff        		woff
        AddType font/woff2  			            woff2

        AddType audio/mpeg 							mp3
        AddType audio/mp4 							m4a mp4 mpa                                                           
        AddType audio/ogg 							ogg
        AddType audio/ogg 							oga
        AddType audio/webm 							webma
        AddType audio/wav 							wav

        AddType video/ogg 							ogv
        AddType video/ogg 							ogg
        AddType video/mp4 							mp4
        AddType video/webm 							webm
        AddType application/x-shockwave-flash   	swf

        AddType text/calendar                       ics  

        AddType application/xml                     rss atom xml rdf
        AddType application/x-chrome-extension      crx
        AddType application/x-opera-extension       oex
        AddType application/x-xpinstall             xpi
        AddType application/octet-stream            gpx
        AddType application/octet-stream            kml
        AddType application/octet-stream            kmz 
        AddType text/x-vcard                        vcf
        AddType text/vtt                            vtt
    </IfModule>


#### KOMPRIMIERUNG

    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/css text/javascript text/calendar application/javascript application/json application/xml  image/svg+xml
    </IfModule>


#### HEADER

    <IfModule mod_headers.c>
        Header unset SERVER
        Header set X-Content-Type-Options nosniff
        Header set X-Frame-Options "SAMEORIGIN"
        Header unset X-Powered-By
        Header set X-XSS-Protection "1; mode=block"
        Header set X-UA-Compatible "IE=edge"
        <FilesMatch "\.(appcache|atom|bbaw|bmp|crx|css|cur|eot|f4[abpv]|flv|geojson|gif|htc|ico|jpe?g|js|json(ld)?|m4[av]|manifest|map|mp4|oex|og[agv]|opus|otf|pdf|png|rdf|rss|safariextz|svgz?|swf|topojson|tt[cf]|txt|vcard|vcf|vtt|webapp|web[mp]|webmanifest|woff2?|xloc|xml|xpi)$">
            Header unset Content-Security-Policy
            Header unset X-Frame-Options
            Header unset X-UA-Compatible
            Header unset X-XSS-Protection
        </FilesMatch>
        Header set Connection keep-alive
        Header unset ETag
        Header set Cache-Control "private, no-transform"
        <FilesMatch "\.(css|gif|jpe?g|pdf|png|svg|ttf|woff|woff2)$">
            Header set Cache-Control "public, private"
        </FilesMatch>
    </IfModule>

    FileETag None

#### SERVER

### COOKIES

    php_value session.use_strict_mode 1
    php_value session.cookie_SameSite lax
    php_value session.cookie_httponly 1
    php_value session.use_cookies 1
    php_value session.use_only_cookies 1
    php_value session.use_trans_sid 0
    php_value session.hash_function sha512


##### SPEZIAL ===========

#### SERVER

ServerSignature Off
Options -Indexes -FollowSymLinks -Includes

## SET! Die Angabe :/tmp undedingt überprüfen  funktionieren Uploads?
#php_value open_basedir /www/htdocs/w00f2f21/web/modx11:/tmp

## SET! Zahl der parallelen Updlosds
    php_value max_file_uploads 10
## SET! Größe von Upload-Files begrenzen    
    php_value upload_max_filesize 2M


## Veraltet! Ab PHP 5.4 überflüssig.
    #php_flag magic_quotes_gpc off
    #php_value date.timezone Europe/Berlin

## Zugriff auf externe Daten
    php_value allow_url_fopen Off
    php_value allow_url_include Off

    AddDefaultCharset UTF-8
## SET!
    DefaultLanguage de-DE
## SET! Zeitzone
    SetEnv TZ Europe/Berlin


### COOKIES

## TEST! Wirkung bei all-ikl.com fraglich
    #php_value session.save_path /tmp/phpfpmsessions/
## SET! Nur bei https verwenden
    php_value session.cookie_secure 1


##### DOMAIN ===========

#### HEADER

    <IfModule mod_headers.c>
## SET! 
        #Header set Content-Security-Policy: 
    </IfModule>

### UMLEITUNGEN
    Options +FollowSymlinks +SymLinksIfOwnerMatch
    RewriteBase /

## ACHTUNG! Die nächsten Blöcke bis <--- schleißen sich gegenseitig aus
## Rewrite deine-site.de -> www.your-site.de
    #RewriteCond %{HTTP_HOST} .
    #RewriteCond %{HTTP_HOST} !^www\.your-site\.de [NC]
    #RewriteRule (.*) http://www.your-site.de/$1 [R=301,L]

#RewriteCond %{HTTPS} !=on
    #RewriteCond %{HTTP_HOST} ^www.(.+)$ [NC]
    #RewriteRule ^ http://%1%{REQUEST_URI} [R=301,L]

#RewriteCond %{HTTPS} !=on
    #RewriteCond %{HTTP_HOST} !^www..+$ [NC]
    #RewriteRule ^ http://www.%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

## Rewrite www.deine-site.de -> deine-site.de
    #RewriteCond %{HTTP_HOST} .
    #RewriteCond %{HTTP_HOST} !^your-site\.de [NC]
    #RewriteRule (.*) http://your-site.de/$1 [R=301,L]


## Rewrite alles auf https://
    RewriteCond %{HTTPS} on
    RewriteCond %{HTTP_HOST} ^www\.(.*)
    RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

## Rewrite alles auf https://www.
    #RewriteCond %{HTTP_HOST} ^[^.]+\.[^.]+$
    #RewriteCond %{HTTPS}s ^on(s)|
    #RewriteRule ^ http%1://www.%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
## <--- ENDE

## Zeitstempel einfügen in Dateien nach dem Schema mein-script.min.js. Muss mit PHP aufgelöst werden
    RewriteRule (.+)\.(min|dev)\.(\d+)\.(js|css)$ $1.$2.$4 [L]

## MODx Evo: Exclude /assets and /manager directories and images from rewrite rules
    RewriteRule ^(manager|assets|js|css|images|img)/.*$ - [L]
    RewriteRule \.(jpg|jpeg|png|gif|ico)$ - [L]

## MODx Evo: Fix Apache internal dummy connections from breaking [(site_url)] cache
    RewriteCond %{HTTP_USER_AGENT} ^.*internal\ dummy\ connection.*$ [NC]
    RewriteRule .* - [F,L]

## MODx Evo: For Friendly URLs
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]